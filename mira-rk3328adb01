#!/bin/bash
set -e

REPO_URL="https://github.com/smatecvn/rk3328.git"

DEST_DIR="/home"
TMP_DIR="/home/.rk3328_tmp"

SETUP_DIR="/home/setup"
DOCKER_DIR="/home/docker"

DOCKER_IMAGE="sonnh911/openwrt"

echo "===== STEP 1: Clone rk3328 safely into /home ====="

[ -d "$TMP_DIR" ] && rm -rf "$TMP_DIR"
git clone "$REPO_URL" "$TMP_DIR"

echo "Copy rk3328 contents to /home (including .git)"
shopt -s dotglob
cp -a "$TMP_DIR"/* "$DEST_DIR"/
shopt -u dotglob
rm -rf "$TMP_DIR"

echo
echo "===== STEP 2: chmod +x setup_mira.sh ====="

if [ -f "$SETUP_DIR/setup_mira.sh" ]; then
    chmod +x "$SETUP_DIR/setup_mira.sh"
else
    echo "ERROR: $SETUP_DIR/setup_mira.sh not found"
    exit 1
fi

echo
echo "===== STEP 3: Run setup_mira.sh ====="

(
    cd "$SETUP_DIR"
    ./setup_mira.sh
)

echo
echo "===== STEP 4: Check TAG environment variable ====="

if [ -z "$TAG" ]; then
    echo "TAG not set, fetching latest from Docker Hub"
    TAG=$(curl -s \
        "https://hub.docker.com/v2/repositories/${DOCKER_IMAGE}/tags?page_size=1" \
        | grep -o '"name":"[^"]*"' \
        | head -n1 \
        | cut -d':' -f2 \
        | tr -d '"')

    if [ -z "$TAG" ]; then
        echo "ERROR: Cannot fetch TAG"
        exit 1
    fi
    export TAG
fi

echo "Using TAG=$TAG"

echo
echo "===== STEP 5: docker compose up -d ====="

cd "$DOCKER_DIR"
docker compose up -d

echo
echo "===== ALL DONE SUCCESSFULLY ====="
